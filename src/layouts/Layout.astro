---

import '../assets/css/critical.css'
import '../assets/css/global.css'
import '../assets/css/non-critical.css'
import "../assets/css/base.css"
import "../assets/css/typography.css"
import "../assets/css/layout.css"
import "../assets/css/buttons.css"

import { Font } from 'astro:assets';

import Image from "astro/components/Image.astro"
import bg_image from "../assets/theme-images/hero-image.jpg"

import { getLangFromUrl, useTranslations } from '../i18n/ui';

import DialogModal from "../components/DialogModal.astro"
import FooterMain from "../components/FooterMain.astro"
import HeaderMain from "../components/HeaderMain.astro"

import global_settings from "../data/global_settings.json"

const { title, description, image, type = "website" } = Astro.props
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Try to load i18n content, fallback to original
let i18nContent;
try {
  i18nContent = await import(`../i18n/content/${lang}.json`);
} catch (error) {
  console.warn(`Could not load i18n content for ${lang}, using fallback`);
}

// Use i18n content if available, otherwise use original
const globalSettings = i18nContent?.default?.global_settings || global_settings;

---

<html lang={lang}>

  <head>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />

    <title>{ title ?? globalSettings.title }</title>

    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="manifest" href="/manifest.json" />

    <meta name="description" content={ description ?? globalSettings.description } />
    <meta name="theme-color" content={ globalSettings.theme_color } />

    <!-- Critical CSS - Inline for immediate rendering -->
    <style is:inline>
      /* Critical CSS content will be inlined here by Astro */
    </style>

    <!-- Preload critical resources -->
    <link rel="preload" href="/src/assets/fonts/Inter-Regular.woff2" as="font" type="font/woff2" crossorigin />
    <link rel="preload" href="/src/assets/fonts/InterDisplay-Regular.woff2" as="font" type="font/woff2" crossorigin />
    
    <!-- Preload hero image for LCP optimization -->
    <link rel="preload" href="/src/assets/theme-images/hero-image.jpg" as="image" />

    <!-- Non-critical CSS - Load asynchronously -->
    <link rel="preload" href="/src/assets/css/non-critical.css" as="style" onload="this.onload=null;this.rel='stylesheet'" />
    <noscript><link rel="stylesheet" href="/src/assets/css/non-critical.css" /></noscript>

    <!-- Open Graph -->
    <meta property="og:title" content={ title ?? globalSettings.title } />
    <meta property="og:description" content={ description ?? globalSettings.description } />
    <meta property="og:type" content={ type } />
    <meta property="og:locale" content={lang === 'es' ? 'es_ES' : 'en_US'} />
    <meta property="og:url" content={ Astro.url.href } />
    <meta
      property="og:image"
      content={ image ? (image.startsWith('http') ? image : globalSettings.base_url + image) : globalSettings.base_url + globalSettings.social_image }
    />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:site_name" content="Frontier Agency" />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={ title ?? globalSettings.title } />
    <meta name="twitter:description" content={ description ?? globalSettings.description } />
    <meta name="twitter:image" content={ image ? (image.startsWith('http') ? image : globalSettings.base_url + image) : globalSettings.base_url + globalSettings.social_image } />
    <meta name="twitter:site" content="@frontieragency" />

    <!-- hreflang tags for SEO -->
    <link rel="alternate" hreflang="en" href={Astro.url.origin + Astro.url.pathname.replace(/^\/es/, '')} />
    <link rel="alternate" hreflang="es" href={Astro.url.origin + (Astro.url.pathname.startsWith('/es') ? Astro.url.pathname : '/es' + Astro.url.pathname)} />
    <link rel="alternate" hreflang="x-default" href={Astro.url.origin + Astro.url.pathname.replace(/^\/es/, '')} />

    <!-- Canonical URL -->
    <link rel="canonical" href={Astro.url.origin + (lang === 'en' ? Astro.url.pathname : Astro.url.pathname.replace(/^\/es/, ''))} />

    <Font cssVariable="--font-inter" preload />
    <Font cssVariable="--font-inter-display" preload />

  </head>

  <body id="top">

    <!-- Skip link -->
    <a class="fixed -top-20 focus-visible:top-0 p-3 bg-black/90 transition-all duration-300" href="#main">{t('skip.content')}</a>

    <!-- bg image -->
    <Image src={ bg_image } alt="" format="avif" height={1080} width={1920} class="absolute min-h-svh object-cover inset-0 bottom-auto -z-1 w-full h-auto opacity-20 mask-b-from-50%" loading="eager" />

    <!-- Header -->
    <HeaderMain settings={ globalSettings } />

    <!-- Main slot -->
    <main id="main">
      <slot />
    </main>

    <!-- Footer -->
    <FooterMain settings={ globalSettings } />

    <!-- Demo dialog modal -->
    <DialogModal id="demo" content={ globalSettings.demo } />

    <!-- Hidden form for Netlify detection -->
    <form name="contact" data-netlify="true" data-netlify-honeypot="bot-field" hidden>
      <input type="text" name="name" />
      <input type="text" name="company" />
      <input type="email" name="email" />
      <input name="bot-field" />
    </form>

    <!-- Hidden newsletter form for Netlify detection -->
    <form name="newsletter" data-netlify="true" data-netlify-honeypot="bot-field" hidden>
      <input type="text" name="name" />
      <input type="email" name="email" />
      <input name="bot-field" />
    </form>

    <!-- Performance optimization script -->
    <script>
      // Optimize CSS loading
      function loadCSS(href) {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = href;
        document.head.appendChild(link);
      }

      // Load non-critical CSS after page load
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          setTimeout(() => loadCSS('/src/assets/css/non-critical.css'), 100);
        });
      } else {
        setTimeout(() => loadCSS('/src/assets/css/non-critical.css'), 100);
      }

      // Preload critical images
      const criticalImages = [
        '/src/assets/theme-images/hero-image.jpg'
      ];

      criticalImages.forEach(src => {
        const link = document.createElement('link');
        link.rel = 'preload';
        link.as = 'image';
        link.href = src;
        document.head.appendChild(link);
      });
    </script>

  </body>
</html>

